#!/bin/bash

# SEED AI Framework Installer
set -e

# Style definitions
BOLD="\033[1m"
GREEN="\033[0;32m"
BLUE="\033[0;34m"
RED="\033[0;31m"
NC="\033[0m"

# Progress tracking
STEPS_TOTAL=6
CURRENT_STEP=0

# Logging with progress
show_progress() {
    CURRENT_STEP=$((CURRENT_STEP + 1))
    PERCENTAGE=$((CURRENT_STEP * 100 / STEPS_TOTAL))
    FILLED=$((PERCENTAGE / 2))
    EMPTY=$((50 - FILLED))
    
    # Create the progress bar
    PROGRESS=""
    for ((i=0; i<FILLED; i++)); do PROGRESS+="#"; done
    for ((i=0; i<EMPTY; i++)); do PROGRESS+="-"; done
    
    # Show progress bar and message
    echo -e "\r${BLUE}${BOLD}[$PROGRESS] ${PERCENTAGE}%${NC} $1"
}

log_error() { echo -e "\n${RED}${BOLD}Error:${NC} $1" >&2; }

# Show title
echo -e "\n${BOLD}SEED AI Framework Installer${NC}\n"

# Check requirements
show_progress "Checking requirements..."
if ! command -v git &> /dev/null; then
    log_error "Git is required but not installed. Please install git first."
    exit 1
fi

# Create temporary directory
TMP_DIR=$(mktemp -d)
show_progress "Preparing installation..."

# Clone repository
show_progress "Downloading SEED framework..."
git clone --quiet https://github.com/Administratum227/seed-ai.git "$TMP_DIR"

# Setup environment
show_progress "Setting up environment..."
mkdir -p "$HOME/.seed"
python3 -m venv "$HOME/.seed/env"
source "$HOME/.seed/env/bin/activate"

# Install package
show_progress "Installing SEED framework..."
cd "$TMP_DIR"
pip install --quiet -e .

# Create launcher
show_progress "Creating launcher..."
mkdir -p "$HOME/.local/bin"
cat > "$HOME/.local/bin/seed" << 'EOL'
#!/bin/bash
source "$HOME/.seed/env/bin/activate"
exec seed "$@"
EOL
chmod +x "$HOME/.local/bin/seed"

# Update PATH
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
    [ -f "$HOME/.zshrc" ] && echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.zshrc"
fi

# Cleanup
rm -rf "$TMP_DIR"

# Show completion message
echo -e "\n${GREEN}${BOLD}Installation Complete!${NC}"
echo -e "\nTo get started:"
echo -e "1. Close and reopen your terminal, or run:"
echo -e "   source ~/.bashrc  # for bash"
echo -e "   source ~/.zshrc   # for zsh"
echo -e "\n2. Then launch the dashboard:"
echo -e "   seed"